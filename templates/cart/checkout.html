{% extends 'base.html' %}

{% block title %}إتمام الطلب - متجرنا{% endblock %}

{% block content %}
<style>
    .payment-option {
        border: 1px solid #dee2e6;
        border-radius: .375rem;
        padding: 1rem;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }
    .payment-option:hover, .payment-option.selected {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), .25);
    }
    .payment-option.selected {
        background-color: #f8f9fa;
    }
    .payment-option .form-check-input {
        display: none;
    }
    .payment-details {
        display: none;
        padding-top: 1rem;
        margin-top: 1rem;
        border-top: 1px solid #dee2e6;
    }
    .apple-pay-button {
        display: inline-block;
        background-color: #000;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        text-align: center;
        width: 100%;
    }
    .apple-pay-button .fab {
        margin-right: 8px;
    }
</style>

<section class="checkout-page py-5 bg-light">
    <div class="container">
        <div class="text-center mb-5">
            <h1 class="fw-bold">إتمام الطلب</h1>
            <p class="text-muted">أنت على بعد خطوة واحدة من الحصول على منتجاتك الرائعة.</p>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <form action="{{ url_for('cart.checkout') }}" method="post" enctype="multipart/form-data" id="checkout-form" novalidate>
            {{ form.csrf_token }}
            {% if form.errors %}
                <div class="alert alert-danger">
                    <ul class="mb-0">
                        {% for field, errors in form.errors.items() %}
                            {% for error in errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            <div class="row g-5">
                <!-- Shipping & Payment Column -->
                <div class="col-lg-7">
                    <!-- Shipping Info -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white py-3">
                            <h4 class="mb-0"><i class="fas fa-truck me-2"></i>معلومات الشحن</h4>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="name">الاسم الكامل</label>
                                    {{ form.name(class="form-control", id="name") }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback d-block"> {{ form.name.errors[0] }} </div>
                                    {% endif %}
                                </div>
                                <div class="col-12">
                                    <label for="email"> البريد الإلكتروني</label>
                                    {{ form.email(class="form-control", id="email") }}
                                    {% if form.email.errors %}
                                        <div class="invalid-feedback d-block"> {{ form.email.errors[0] }} </div>
                                    {% endif %}
                                </div>
                                <div class="col-12">
                                    <label for="phone"> رقم الهاتف</label>
                                    {{ form.phone(class="form-control", id="phone") }}
                                    {% if form.phone.errors %}
                                        <div class="invalid-feedback d-block"> {{ form.phone.errors[0] }} </div>
                                    {% endif %}
                                </div>
                                <div class="col-12">
                                    <label for="governorate_id"> المحافظة</label>
                                    {{ form.governorate_id(class="form-control", id="governorate_id") }}
                                    {% if form.governorate_id.errors %}
                                        <div class="invalid-feedback d-block"> {{ form.governorate_id.errors[0] }} </div>
                                    {% endif %}
                                </div>
                                <div class="col-12">
                                    <label for="address">العنوان بالتفصيل (الشارع، رقم المنزل، علامة مميزة)</label>
                                    {{ form.address(class="form-control", id="address") }}
                                    {% if form.address.errors %}
                                        <div class="invalid-feedback d-block"> {{ form.address.errors[0] }} </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Methods -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-white py-3">
                            <h4 class="mb-0"><i class="fas fa-credit-card me-2"></i>اختر طريقة الدفع</h4>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-3">
                                <!-- Cash on Delivery -->
                                <label for="payment-cod" class="payment-option" id="cod-option">
                                    {{ form.payment_method(class="form-check-input", type="radio", id="payment-cod", value="cod", checked=true) }}
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-money-bill-wave fa-2x me-3 text-success"></i>
                                        <div>
                                            <h6 class="mb-0 fw-bold">الدفع عند الاستلام</h6>
                                            <p class="text-muted mb-0 small">الدفع نقدًا لمندوب الشحن عند استلام طلبك.</p>
                                        </div>
                                    </div>
                                </label>

                                <!-- Vodafone Cash -->
                                <label for="payment-vodafone" class="payment-option" id="vodafone-option">
                                    {{ form.payment_method(class="form-check-input", type="radio", id="payment-vodafone", value="vodafone_cash") }}
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-wallet fa-2x me-3 text-danger"></i>
                                        <div>
                                            <h6 class="mb-0 fw-bold">فودافون كاش</h6>
                                            <p class="text-muted mb-0 small">تحويل المبلغ إلى محفظتنا ورفع صورة الإيصال.</p>
                                        </div>
                                    </div>
                                    <div class="payment-details" id="vodafone-details">
                                        <p>يرجى تحويل المبلغ الإجمالي إلى الرقم: <strong class="text-danger">01023820614</strong></p>
                                        <label for="vodafone_receipt" class="form-label">ارفع صورة إيصال الدفع</label>
                                        {{ form.vodafone_receipt(class="form-control", id="vodafone_receipt", accept="image/*") }}
                                        <div class="form-text">هذه الخطوة تؤكد عملية الدفع وتسرع من توصيل الطلب.</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary Column -->
                <div class="col-lg-5">
                    <div class="card shadow-sm sticky-top" style="top: 2rem;">
                        <div class="card-header bg-white py-3">
                            <h4 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>ملخص الطلب</h4>
                        </div>
                        <div class="card-body">
                            <!-- حقل كود الخصم -->
                            <div class="form-group mb-4">
                                <div class="input-group">
                                    <input type="text" id="promoCode" class="form-control" placeholder="أدخل كود الخصم">
                                    <div class="input-group-append">
                                        <button class="btn btn-primary" type="button" id="applyPromoCode">
                                            <i class="fas fa-tag"></i> تطبيق
                                        </button>
                                    </div>
                                </div>
                                <small id="promoCodeMessage" class="form-text"></small>
                            </div>

                            <div class="table-responsive">
                                <table class="table">
                                    <tbody>
                                        {% for item in cart_items %}
                                        <tr>
                                            <td>
                                                <img src="{{ url_for('static', filename='uploads/' + item.product.image) }}" 
                                                     alt="{{ item.product.name }}" class="img-thumbnail" style="width: 50px;">
                                                {{ item.product.name }}
                                                {% if item.color %} - {{ item.color }}{% endif %}
                                                {% if item.size %} - {{ item.size }}{% endif %}
                                            </td>
                                            <td class="text-left">{{ item.quantity }}</td>
                                            <td class="text-left">{{ (item.product.price * item.quantity)|round(2) }} جنيه</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="2" class="text-right"><strong>إجمالي المنتجات:</strong></td>
                                            <td class="text-left" id="subtotal">{{ products_total|round(2) }} جنيه</td>
                                        </tr>
                                        <tr id="discountRow" style="display: none;">
                                            <td colspan="2" class="text-right"><strong>الخصم:</strong></td>
                                            <td class="text-left" id="discountAmount">0.00 جنيه</td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="text-right"><strong>رسوم الشحن:</strong></td>
                                            <td class="text-left" id="shipping-cost">--</td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="text-right"><strong>الإجمالي النهائي:</strong></td>
                                            <td class="text-left" id="final-total">--</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <div class="card-footer bg-white p-3">
                            <button type="submit" class="btn btn-primary btn-lg w-100" id="submit-order">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                تأكيد الطلب الآن
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentOptions = document.querySelectorAll('.payment-option');
    
    function updateSelection(selectedOption) {
        paymentOptions.forEach(option => {
            const details = option.querySelector('.payment-details');
            if (option === selectedOption) {
                option.classList.add('selected');
                if (details) {
                    details.style.display = 'block';
                }
            } else {
                option.classList.remove('selected');
                if (details) {
                    details.style.display = 'none';
                }
            }
        });
    }

    paymentOptions.forEach(option => {
        option.addEventListener('click', function() {
            this.querySelector('input[type="radio"]').checked = true;
            updateSelection(this);
        });
    });

    // Set initial state based on checked radio
    const initiallyChecked = document.querySelector('input[type="radio"]:checked');
    if (initiallyChecked) {
        updateSelection(initiallyChecked.closest('.payment-option'));
    }

    // Attach submit event to the main form
    document.getElementById('checkout-form').addEventListener('submit', function(e) {
        const selectedPayment = document.querySelector('input[name="payment_method"]:checked').value;
        if (selectedPayment === 'vodafone_cash') {
            const receiptInput = document.getElementById('vodafone_receipt');
            if (!receiptInput.files.length) {
                e.preventDefault();
                alert('يرجى رفع إيصال الدفع عند اختيار فودافون كاش.');
            }
        }
    });

    // تحديث رسوم الشحن والمجموع الكلي عند تغيير المحافظة
    const governorateSelect = document.getElementById('governorate_id');
    const shippingCostElem = document.getElementById('shipping-cost');
    const finalTotalElem = document.getElementById('final-total');
    const productsTotal = parseFloat("{{ products_total|round(2) }}");

    function updateTotals(deliveryFee) {
        let total = productsTotal + deliveryFee;
        if (total < 0) total = 0;
        shippingCostElem.textContent = deliveryFee.toFixed(2) + ' جنيه';
        finalTotalElem.textContent = total.toFixed(2) + ' جنيه';
    }

    if (governorateSelect) {
        governorateSelect.addEventListener('change', function() {
            const govId = this.value;
            if (govId) {
                fetch(`/cart/get_delivery_fee/${govId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.delivery_fee !== undefined) {
                            updateTotals(parseFloat(data.delivery_fee));
                        }
                    });
            }
        });
    }
});
</script>

{% block extra_js %}
{{ super() }}
<script>
$(document).ready(function() {
    let promoCodeApplied = false;
    const csrfToken = "{{ csrf_token() }}";

    // تطبيق كود الخصم
    $('#applyPromoCode').click(function() {
        const code = $('#promoCode').val().trim();
        if (!code) {
            showPromoMessage('يرجى إدخال كود الخصم', 'danger');
            return;
        }

        $.ajax({
            url: "{{ url_for('cart.apply_promocode') }}",
            method: 'POST',
            data: {
                code: code,
                csrf_token: csrfToken
            },
            success: function(response) {
                if (response.success) {
                    showPromoMessage(response.message, 'success');
                    updateOrderSummary(response.data);
                    promoCodeApplied = true;
                    $('#promoCode').prop('disabled', true);
                    $('#applyPromoCode').prop('disabled', true);
                    // إضافة زر لإزالة الكود
                    if (!$('#removePromoCode').length) {
                        $('#applyPromoCode').after(
                            '<button class="btn btn-outline-danger" type="button" id="removePromoCode">' +
                            '<i class="fas fa-times"></i> إزالة الكود</button>'
                        );
                    }
                } else {
                    showPromoMessage(response.message, 'danger');
                }
            },
            error: function() {
                showPromoMessage('حدث خطأ أثناء تطبيق الكود', 'danger');
            }
        });
    });

    // إزالة كود الخصم
    $(document).on('click', '#removePromoCode', function() {
        $.ajax({
            url: "{{ url_for('cart.remove_promocode') }}",
            method: 'POST',
            data: {
                csrf_token: csrfToken
            },
            success: function(response) {
                if (response.success) {
                    showPromoMessage(response.message, 'success');
                    updateOrderSummary(response.data);
                    promoCodeApplied = false;
                    $('#promoCode').prop('disabled', false).val('');
                    $('#applyPromoCode').prop('disabled', false);
                    $('#removePromoCode').remove();
                }
            },
            error: function() {
                showPromoMessage('حدث خطأ أثناء إزالة الكود', 'danger');
            }
        });
    });

    function showPromoMessage(message, type) {
        $('#promoCodeMessage')
            .removeClass('text-danger text-success')
            .addClass('text-' + type)
            .text(message);
    }

    function updateOrderSummary(data) {
        $('#subtotal').text(data.original_amount.toFixed(2) + ' جنيه');
        if (data.discount_amount > 0) {
            $('#discountRow').show();
            $('#discountAmount').text('-' + data.discount_amount.toFixed(2) + ' جنيه');
        } else {
            $('#discountRow').hide();
            $('#discountAmount').text('0.00 جنيه');
        }
        $('#final-total').text(data.final_amount.toFixed(2) + ' جنيه');
    }

    // تحديث رسوم التوصيل عند تغيير المحافظة
    $('#governorate_id').change(function() {
        const governorateId = $(this).val();
        if (governorateId) {
            $.get(`/cart/get_delivery_fee/${governorateId}`)
                .done(function(response) {
                    if (response.success) {
                        const deliveryFee = parseFloat(response.delivery_fee);
                        $('#shipping-cost').text(deliveryFee.toFixed(2) + ' جنيه');
                        // تحديث الإجمالي النهائي
                        const subtotal = parseFloat($('#subtotal').text());
                        const discount = promoCodeApplied ? 
                            parseFloat($('#discountAmount').text().replace('-', '').replace(' جنيه', '')) : 0;
                        const total = subtotal - discount + deliveryFee;
                        $('#final-total').text(total.toFixed(2) + ' جنيه');
                    }
                });
        } else {
            $('#shipping-cost').text('0.00 جنيه');
        }
    });
});
</script>
{% endblock %}
{% endblock %}